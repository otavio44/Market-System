name: Tests

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    env:
      APP_ENV: local
      APP_KEY: base64:OjfysOLJcVb32GG0R8Cl80l2iqjySqAKY3n054fTrwk=
      APP_DEBUG: true

      CLEARDB_DATABASE_URL: mysql://be940d575dae1a:a455cebc@us-cdbr-east-05.cleardb.net/heroku_807634155b4145d?reconnect=true

      DB_CONNECTION: mysql
      DB_HOST: us-cdbr-east-05.cleardb.net
      DB_PORT: 3306
      DB_DATABASE: heroku_807634155b4145d
      DB_USERNAME: be940d575dae1a
      DB_PASSWORD: a455cebc

      MAIL_DRIVER: smtp
      MAIL_HOST: smtp.gmail.com
      MAIL_PORT: 587
      MAIL_USERNAME: webstamp.unifal@gmail.com
      MAIL_PASSWORD: xqfyuaoxpoxlengn
      MAIL_ENCRYPTION: tls

      PAPERTRAIL_API_TOKEN: s6GyB2HsY1mhVjZjlC

    steps:
    - uses: actions/checkout@v2
    - name: Build container
      run: docker-compose up -d --build
    - name: Run docker ps -a
      run: docker ps -a
    - name: Install dependencies 
      run: docker exec -u 0 webstamp-app composer install -q --ignore-platform-reqs --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
    - name: Generate Keys
      run: docker exec -u 0 webstamp-app php artisan key:generate
    - name: Run docker ps
      run: docker ps -a
    - name: Run Tests
      run: docker exec -u 0 webstamp-app vendor/bin/phpunit tests/EndToEnd
